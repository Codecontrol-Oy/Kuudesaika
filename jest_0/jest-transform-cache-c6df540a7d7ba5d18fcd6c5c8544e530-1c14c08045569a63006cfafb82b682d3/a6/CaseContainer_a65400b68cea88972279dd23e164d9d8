'use strict';Object.defineProperty(exports, "__esModule", { value: true });exports.default = undefined;var _createClass = function () {function defineProperties(target, props) {for (var i = 0; i < props.length; i++) {var descriptor = props[i];descriptor.enumerable = descriptor.enumerable || false;descriptor.configurable = true;if ("value" in descriptor) descriptor.writable = true;Object.defineProperty(target, descriptor.key, descriptor);}}return function (Constructor, protoProps, staticProps) {if (protoProps) defineProperties(Constructor.prototype, protoProps);if (staticProps) defineProperties(Constructor, staticProps);return Constructor;};}();var _dec, _class;var _react = require('react');var _react2 = _interopRequireDefault(_react);
var _reactRedux = require('react-redux');
var _global = require('../../theme/global.scss');var _global2 = _interopRequireDefault(_global);
var _axios = require('axios');var _axios2 = _interopRequireDefault(_axios);
var _Section = require('grommet/components/Section');var _Section2 = _interopRequireDefault(_Section);
var _Anchor = require('grommet/components/Anchor');var _Anchor2 = _interopRequireDefault(_Anchor);
var _Article = require('grommet/components/Article');var _Article2 = _interopRequireDefault(_Article);
var _Label = require('grommet/components/Label');var _Label2 = _interopRequireDefault(_Label);
var _Timestamp = require('grommet/components/Timestamp');var _Timestamp2 = _interopRequireDefault(_Timestamp);
var _Accordion = require('grommet/components/Accordion');var _Accordion2 = _interopRequireDefault(_Accordion);
var _AccordionPanel = require('grommet/components/AccordionPanel');var _AccordionPanel2 = _interopRequireDefault(_AccordionPanel);
var _Heading = require('grommet/components/Heading');var _Heading2 = _interopRequireDefault(_Heading);
var _components = require('../../components');
var _reactRouter = require('react-router');
var _actions = require('../../actions');
var _CircleInformation = require('grommet/components/icons/base/CircleInformation');var _CircleInformation2 = _interopRequireDefault(_CircleInformation);function _interopRequireDefault(obj) {return obj && obj.__esModule ? obj : { default: obj };}function _classCallCheck(instance, Constructor) {if (!(instance instanceof Constructor)) {throw new TypeError("Cannot call a class as a function");}}function _possibleConstructorReturn(self, call) {if (!self) {throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call && (typeof call === "object" || typeof call === "function") ? call : self;}function _inherits(subClass, superClass) {if (typeof superClass !== "function" && superClass !== null) {throw new TypeError("Super expression must either be null or a function, not " + typeof superClass);}subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } });if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass;}var








CaseContainer = (_dec = (0, _reactRedux.connect)(function (store) {return { selected_case: store.case.selected_case, cases: store.case.latest_cases };}), _dec(_class = function (_React$Component) {_inherits(CaseContainer, _React$Component);
	function CaseContainer(props) {_classCallCheck(this, CaseContainer);var _this = _possibleConstructorReturn(this, (CaseContainer.__proto__ || Object.getPrototypeOf(CaseContainer)).call(this,
		props));_this.










		componentDidMount = function () {
			(0, _actions.setCity)(_this.props.params.city);
			var case_id = _this.props.params.id;
			_this.setState({ fetchStarted: false }, function () {
				(0, _actions.fetchLatest)();
				(0, _actions.fetchCase)(case_id);
			});
		};_this.

		componentDidUpdate = function () {
			var selected_case = _this.state.selected_case || _this.props.selected_case;
			if (selected_case && !_this.state.fetchStarted) {
				_this.setState({ fetchStarted: true }, function () {
					if (selected_case.actions && selected_case.actions.length > 0) {
						this.fetchActions(selected_case);
					}
				});
			}
		};_this.

		gatherActions = function () {
			var actionListing = [];
			if (_this.state.actions) {
				_this.state.actions.map(function (action) {
					var actionList = [];
					action.contents.sort(function (a, b) {return a.ordering - b.ordering;}).
					map(function (content) {
						actionList.push(_react2.default.createElement(_Section2.default, { key: content.origin_id + '_Action' },
							_react2.default.createElement(_Heading2.default, { tag: "h5", uppercase: true },
								content.title),

							_react2.default.createElement(_Article2.default, null, _react2.default.createElement('div', { dangerouslySetInnerHTML: { __html: content.hypertext } }))));

					});
					actionListing.push(_react2.default.createElement(_AccordionPanel2.default, {
							key: action.id + '_actionValue',
							heading: _react2.default.createElement(_Label2.default, null, action.title) },
						actionList,
						_react2.default.createElement(_Heading2.default, { tag: "h5" }, 'K\xE4sitelty ',
							_react2.default.createElement(_Timestamp2.default, {
								fields: "date",
								value: action.event ? action.event.start_date : action.post.start_date }),

							action.event ? ' ' + action.event.organization.name : ' ' + action.post.organization.name, ' kokouksessa.'),

						action.post && _react2.default.createElement(_Label2.default, null, 'Lausunnonantaja: ', action.post.label),
						_react2.default.createElement(_Anchor2.default, { href: '#', icon: _react2.default.createElement(_CircleInformation2.default, null),
							primary: true,
							label: 'Siirry organisaatioon',
							onClick: function onClick() {return self.onLinkAction(action.event ? action.event.organization.id : action.post.organization.id);} })));

				});
			}
			return actionListing;
		};_this.


		fetchActions = function (selected_case) {
			if (selected_case.function) {
				_axios2.default.get(selected_case.function).
				then(function (functionResponse) {
					selected_case.function = functionResponse.data;
					self.setState({ selected_case: selected_case });
				});
			}
			selected_case.actions.map(function (action) {
				_axios2.default.get(action).
				then(function (actionResponse) {
					var currentAction = actionResponse.data;
					if (currentAction.event) {
						_axios2.default.get(currentAction.event).
						then(function (eventResponse) {
							currentAction.event = eventResponse.data;
							_axios2.default.get(currentAction.event.organization).
							then(function (orgResponse) {
								currentAction.event.organization = orgResponse.data;
								var actions = self.state.actions || [];
								var organizations = self.state.organizations || [];
								actions.push(currentAction);
								organizations.push(orgResponse.data);
								self.setState({ actions: actions, organizations: organizations, pending: false });
							});
						});
					} else {
						_axios2.default.get(currentAction.post).
						then(function (postResponse) {
							currentAction.post = postResponse.data;
							_axios2.default.get(currentAction.post.organization).
							then(function (orgResponse) {
								currentAction.post.organization = orgResponse.data;
								var actions = self.state.actions || [];
								var organizations = self.state.organizations || [];
								actions.push(currentAction);
								organizations.push(orgResponse.data);
								self.setState({ actions: actions, organizations: organizations, pending: false });
							});
						});
					}
				});
			});
		};_this.

		onLinkAction = function (id) {
			_reactRouter.browserHistory.push('/' + (0, _actions.getCity)() + '/organisaatio/' + id);
		};_this.state = { actionListing: null, actions: null, organizations: null, pending: true, selected_case: null };self = _this;return _this;}_createClass(CaseContainer, [{ key: 'render', value: function render()

		{
			var cases = this.props.cases;
			var selected_case = this.state.selected_case;
			var actions = this.gatherActions();
			var attachments = this.state.attachments;
			var pending = this.state.pending;

			return (
				_react2.default.createElement(_Section2.default, { pad: 'small' },
					selected_case && cases ?
					_react2.default.createElement(_Section2.default, null,
						_react2.default.createElement(_Heading2.default, { tag: "h3", uppercase: true, className: _global2.default.sectionTitle },
							selected_case.title,
							_react2.default.createElement(_Article2.default, null, _react2.default.createElement(_Label2.default, null, selected_case.function.name))),


						_react2.default.createElement(_Heading2.default, { className: _global2.default.marginTop, tag: "h4", uppercase: true }, 'Maininnat'),
						!pending ?
						actions && actions.length > 0 ?
						_react2.default.createElement(_Accordion2.default, { onActive: this.onAccordionChange },
							actions) :

						_react2.default.createElement(_Label2.default, null, 'Ei mainintoja') :
						_react2.default.createElement(_components.Loader, null),


						_react2.default.createElement(_Heading2.default, { className: _global2.default.marginTop, tag: "h4", uppercase: true }, 'Liitteet'),
						!pending ?
						attachments && attachments.length > 0 ?
						_react2.default.createElement(_Accordion2.default, { onActive: this.onPostAccordionChange },
							attachments) :

						_react2.default.createElement(_Label2.default, null, 'Ei liitteit\xE4') :
						_react2.default.createElement(_components.Loader, null),

						selected_case.geometries && selected_case.geometries.length > 0 &&
						_react2.default.createElement(_Section2.default, null,
							_react2.default.createElement(_Heading2.default, { className: _global2.default.marginTop, tag: "h4", uppercase: true }, 'Aluetiedot'),
							_react2.default.createElement(_components.CaseGeo, { geometries: selected_case.geometries })),

						_react2.default.createElement(_Heading2.default, { className: _global2.default.marginTop, tag: "h4", uppercase: true }, 'Asiaprosessi'),
						!pending ?
						this.state.actions && _react2.default.createElement(_components.CaseMap, { actions: this.state.actions, currentCase: this.state.selected_case }) :
						_react2.default.createElement(_components.Loader, null)) :



					_react2.default.createElement(_components.Loader, null)));



		} }]);return CaseContainer;}(_react2.default.Component)) || _class);exports.default = CaseContainer;